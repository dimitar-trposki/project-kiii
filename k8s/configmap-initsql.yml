apiVersion: v1
kind: ConfigMap
metadata:
  name: initsql
  namespace: bookeshop
data:
  init.sql: |
    CREATE TABLE country
    (
        id        bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name      VARCHAR(255) NOT NULL,
        continent VARCHAR(255) NOT NULL
    );

    CREATE TABLE author
    (
        id         bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name       VARCHAR(255) NOT NULL,
        surname    VARCHAR(255) NOT NULL,
        country_id BIGINT REFERENCES country (id)
    );

    CREATE TABLE book
    (
        id               bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name             VARCHAR(255) NOT NULL,
        category         VARCHAR(255) NOT NULL,
        author_id        BIGINT REFERENCES author (id),
        available_copies INT,
        is_deleted       BOOLEAN DEFAULT FALSE,
        date_created     TIMESTAMP
    );

  views.sql: |
    CREATE MATERIALIZED VIEW books_per_author AS
    SELECT a.id AS author_id, COUNT(b.id) AS book_count
    FROM author a
             LEFT JOIN book b ON a.id = b.author_id
    GROUP BY a.id;

    CREATE MATERIALIZED VIEW authors_per_country AS
    SELECT a.country_id AS country_id, c.name AS country_name, COUNT(*) AS author_count
    FROM author a
             JOIN country c ON a.country_id = c.id
    GROUP BY a.country_id, c.name;
